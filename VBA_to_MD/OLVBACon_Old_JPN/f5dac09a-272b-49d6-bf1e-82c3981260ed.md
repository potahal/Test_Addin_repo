
# Outlook ????? ?????????????????
?????????Microsoft Outlook ???????????????????????????????????????????????????????

 **???:** Ken Getz?[MCW Technologies, LLC](http://www.mcwtech.com/)

Outlook ??????????????????????????????????????1 ??????????????????? ???????????????????????????????????????????????????? ??????????????????????????????????????????????????????????????????????????????????????????????????

?????????????????????? .txt ???????????????????????????????????????? Outlook ?????? **ItemSend** ??????????????????????????? ??????????????????????????????????????? ?????????????????????????????????

??????????? ??????????? **Attachment** ????????? **GetProperty(String)** ????? **SetProperty(String, Object)** ?????????????????????????????????????????????????????MAPI ?????[PidTagAttachDataBinary](http://msdn.microsoft.com/library/3b0a8b28-863e-4b96-a4c0-fdb8f40555b9%28Office.15%29.aspx) ?????????????

 **??**   **PidTagAttachDataBinary** ????????????? http://schemas.microsoft.com/mapi/proptag/0x37010102 ?????????????????????? **PropertyAccessor** ???????????????????????[???????????????](c1c7bfa9-64d7-81d2-84e7-f0a4c57780b3.md)?????????

?????? ???????? ?????  **ItemSend** ???????????.txt ????????????????????? ????????????? `ConvertAttachmentToUpperCase` ???????????? `ConvertAttachmentToUpperCase` ???????? **Attachment** ??????? **MailItem** ???????????????????????????????????????????????????????????????????????????????????????????????????????
?????? ??? ????? C# ??? Visual Basic ????????????????? ?????? ??? (COM) ?????????? .NET Framework ???? ??? ???????????????? ??????????????????? ??? ??? ?????? COM ????????????????????????????????????Outlook ????Visual Studio ??? Outlook ???????????????? (PIA) ????????Outlook 2013 ?????? ??? ????????????Outlook 2013 PIA ????????????Visual Studio ? Microsoft Outlook 15.0 ?????? ????? ??????????????????????????????Outlook ?????  `ThisAddIn` ????????? ?????????? (Visual Studio ? Office Developer Tools ???)????? **Application** ??????? `ThisAddIn.Globals` ??????????? Outlook **Application** ?????????????????Outlook PIA ????????? Outlook ???????????????????MSDN ?? **Outlook ???????????????? ???????????**???????????
????????Outlook ?????????????????????????????????????????????????????????????????Visual Studio ???????? Outlook ???? (??  `ModifyAttachmentAddIn`) ?????????????? ThisAddIn.cs ??? ThisAddIn.vb ????????????????



```C#
using Outlook = Microsoft.Office.Interop.Outlook;
 
namespace ModifyAttachmentAddIn
{
    public partial class ThisAddIn
    {
        private void ThisAddIn_Startup(object sender, System.EventArgs e)
        {
            Application.ItemSend += new Outlook.ApplicationEvents_11_ItemSendEventHandler(Application_ItemSend);
        }
 
        private void ThisAddIn_Shutdown(object sender, System.EventArgs e)
        {
        }
 
 
        void Application_ItemSend(object Item, ref bool Cancel)
        {
            Outlook.MailItem mailItem = Item as Outlook.MailItem;
 
            if (mailItem != null)
            {
                var attachments = mailItem.Attachments;
                // If the attachment a text file, convert its text to all uppercase.
                foreach (Outlook.Attachment attachment in attachments)
                {

                    ConvertAttachmentToUpperCase(attachment, mailItem);
                }
            }
        }
 
        private void ConvertAttachmentToUpperCase(Outlook.Attachment attachment, Outlook.MailItem mailItem)
        {
            const string PR_ATTACH_DATA_BIN =
                "http://schemas.microsoft.com/mapi/proptag/0x37010102";
 
            // Confirm that the attachment is a text file.
            if (System.IO.Path.GetExtension(attachment.FileName) == ".txt")
            {
                // There are other heuristics you could use to determine whether the 
                // the attachment is a text file. For now, keep it simple: Only
                // run this code for *.txt.
 
                // Retrieve the attachment as an array of bytes.
                var attachmentData =
                    attachment.PropertyAccessor.GetProperty(
                    PR_ATTACH_DATA_BIN);
 
                // Convert the byte array into a Unicode string.
                string data = System.Text.Encoding.Unicode.GetString(attachmentData);
                // Convert to upper case.
                data = data.ToUpper();
                // Convert the data back to an array of bytes.
                attachmentData = System.Text.Encoding.Unicode.GetBytes(data);
 
                //Set PR_ATTACH_DATA_BIN to attachmentData.
                attachment.PropertyAccessor.SetProperty(PR_ATTACH_DATA_BIN,
                    attachmentData);
            }
        }
 
        #region VSTO generated code
 
        /// <summary>
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// </summary>
        private void InternalStartup()
        {
            this.Startup += new System.EventHandler(ThisAddIn_Startup);
            this.Shutdown += new System.EventHandler(ThisAddIn_Shutdown);
        }
 
        #endregion
    }
}
```




```VB.net
Public Class ThisAddIn
 
 
    Private Sub ThisAddIn_Startup() Handles Me.Startup
 
    End Sub
 
    Private Sub ThisAddIn_Shutdown() Handles Me.Shutdown
 
    End Sub
 
    Private Sub Application_ItemSend(ByVal Item As Object, _
        ByRef Cancel As Boolean) Handles Application.ItemSend
 
        Dim mailItem As Outlook.MailItem = TryCast(Item, Outlook.MailItem)
 
        If mailItem IsNot Nothing Then
            Dim attachments = mailItem.Attachments
            For Each attachment As Outlook.Attachment In attachments
                ' If the attachment is a text file, convert to uppercase.
                ConvertAttachmentToUpperCase(attachment, mailItem)
            Next attachment
        End If
    End Sub
 
    Private Sub ConvertAttachmentToUpperCase(ByVal attachment As Outlook.Attachment, _
        ByVal mailItem As Outlook.MailItem)
        Const PR_ATTACH_DATA_BIN As String = "http://schemas.microsoft.com/mapi/proptag/0x37010102"
 
        ' Confirm that the attachment is a text file.
        If System.IO.Path.GetExtension(attachment.FileName) = ".txt" Then
 
            ' There are other heuristics you could use to determine whether the 
            ' the attachment is a text file. For now, keep it simple: Only
            ' run this code for *.txt.
 
            ' Retrieve the attachment as an array of bytes.
            Dim attachmentData = attachment.PropertyAccessor.GetProperty(PR_ATTACH_DATA_BIN)
 
            ' Convert the byte array into a Unicode string.
            Dim data As String = System.Text.Encoding.Unicode.GetString(attachmentData)
            ' Convert to upper case.
            data = data.ToUpper()
            ' Convert the data back to an array of bytes.
            attachmentData = System.Text.Encoding.Unicode.GetBytes(data)
 
            'Set PR_ATTACH_DATA_BIN to attachmentData.
            attachment.PropertyAccessor.SetProperty(PR_ATTACH_DATA_BIN, attachmentData)
         End If
    End Sub
 
End Class
```


## ????


#### ??


[??? ????????????????](1d94629b-e713-92cb-32de-c8910612e861.md)
[Outlook ?????????????? ????????????](ae5240ad-dc3e-4499-8fd0-d8c2d90aa9ba.md)
[Outlook ????? ?????????????????????](9a240e17-f715-482c-9a8b-c6be1144e15a.md)